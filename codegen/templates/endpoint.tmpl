{{/* template to render gateway http endpoint code */ -}}
// Code generated by zanzibar
// @generated

package {{.PackageName}}

import (
	"context"
	"io/ioutil"
	"net/http"

	"github.com/pkg/errors"
	"go.uber.org/zap"
	"{{.GatewayPackageName}}/clients"
	zanzibar "github.com/uber/zanzibar/runtime"

	{{range $idx, $pkg := .IncludedPackages -}}
	{{$pkg.AliasName}} "{{$pkg.PackageName}}"
	{{end -}}

	{{if .Method.Downstream }}
	{{- range $idx, $pkg := .Method.Downstream.IncludedPackages -}}
	{{$file := basePath $pkg.PackageName -}}
	{{$pkg.AliasName}} "{{$pkg.PackageName}}"
	{{end}}
	{{- end}}
)

{{ $workflow := .WorkflowName -}}
{{ $clientName := title .ClientName -}}
{{ $handlerName := title .Method.Name | printf "%sHandler" }}pattern
{{with .Method -}}

// {{$handlerName}} is the handler for "{{.HTTPPath}}"
type {{$handlerName}} struct {
	Clients *clients.Clients
}

// New{{title .Name}}Endpoint creates a handler
func New{{title .Name}}Endpoint(
	gateway *zanzibar.Gateway,
) *{{$handlerName}} {
	return &{{$handlerName}}{
		Clients: gateway.Clients.(*clients.Clients),
	}
}

// HandleRequest handles "{{.HTTPPath}}".
func (handler *{{$handlerName}}) HandleRequest(
	ctx context.Context,
	req *zanzibar.ServerHTTPRequest,
	res *zanzibar.ServerHTTPResponse,
) {
	{{- if .Headers -}}
	if !req.CheckHeaders({{.Headers | printf "%#v" }}) {
		return
	}
	{{- end -}}

	{{if ne .RequestType ""}}
	var requestBody {{.RequestType}}
	if ok := req.ReadAndUnmarshalBody(&requestBody); !ok {
		return
	}
	{{end}}

	headers := map[string]string{}

	workflow := {{$workflow}}{
		Clients: handler.Clients,
		Logger: req.Logger,
		Request: req,
	}
	{{if and (eq .RequestType "") (eq .ResponseType "")}}
	_, err := workflow.Handle(ctx, headers)
	{{else if eq .RequestType ""}}
	response, _, err := workflow.Handle(ctx, headers)
	{{else if eq .ResponseType ""}}
	_, err := workflow.Handle(ctx, headers, &requestBody)
	{{else}}
	response, _, err := workflow.Handle(ctx, headers, &requestBody)
	{{end -}}
	if err != nil {
		req.Logger.Warn("Workflow for endpoint returned error",
			zap.String("error", err.Error()),
		)
		res.SendErrorString(500, "Unexpected server error")
		return
	}

	{{if eq .ResponseType "" -}}
	res.WriteJSONBytes({{.OKStatusCode.Code}}, nil)
	{{- else -}}
	res.WriteJSON({{.OKStatusCode.Code}}, response)
	{{- end -}}
}

{{end -}}

{{- if .Method.Downstream }}
{{- with .Method -}}
{{- $clientPackage := .Downstream.PackageName -}}
{{- $clientMethod := .DownstreamMethod -}}
{{- $clientReqType := fullTypeName ($clientMethod).RequestType ($clientPackage) -}}
{{- $clientResType := fullTypeName  ($clientMethod).ResponseType ($clientPackage) -}}
{{- $clientMethodName := title ($clientMethod).Name -}}


// {{$workflow}} calls thrift client {{$clientName}}.{{$clientMethodName}}
type {{$workflow}} struct {
	Clients *clients.Clients
	Logger  *zap.Logger
	Request *zanzibar.ServerHTTPRequest
}

// Handle calls thrift client.
func (w {{$workflow}}) Handle(
{{- if and (eq .RequestType "") (eq .ResponseType "") }}
	ctx context.Context,
	headers map[string]string,
) (map[string]string, error) {
{{else if eq .RequestType "" }}
	ctx context.Context,
	headers map[string]string,
) (*{{.ResponseType}}, map[string]string, error) {
{{else if eq .ResponseType "" }}
	ctx context.Context,
	headers map[string]string,
	r *{{.RequestType}},
) (map[string]string, error) {
{{else}}
	ctx context.Context,
	headers map[string]string,
	r *{{.RequestType}},
) (*{{.ResponseType}}, map[string]string, error) {
{{- end}}
	{{- if ne .RequestType "" -}}
	clientRequest := convertTo{{title .Name}}ClientRequest(r)
	{{end}}

	{{if and (eq $clientReqType "") (eq $clientResType "")}}
	_, err := w.Clients.{{$clientName}}.{{$clientMethodName}}(ctx, nil)
	{{else if eq $clientReqType ""}}
	clientRespBody, _, err := w.Clients.{{$clientName}}.{{$clientMethodName}}(
		ctx, nil,
	)
	{{else if eq $clientResType ""}}
	_, err := w.Clients.{{$clientName}}.{{$clientMethodName}}(
		ctx, nil, clientRequest,
	)
	{{else}}
	clientRespBody, _, err := w.Clients.{{$clientName}}.{{$clientMethodName}}(
		ctx, nil, clientRequest,
	)
	{{end -}}
	if err != nil {
		w.Logger.Warn("Could not make client request",
			zap.String("error", err.Error()),
		)
		return {{if eq .ResponseType ""}}nil, err{{else}}nil, nil, err{{end}}
	}

	{{if eq .ResponseType "" -}}
	return nil, nil
	{{- else -}}
	response := convert{{title .Name}}ClientResponse(clientRespBody)
	return response, nil, nil
	{{- end -}}
}

{{if and (ne .RequestType "") (ne $clientReqType "") -}}
func convertTo{{title .Name}}ClientRequest(body *{{title .RequestType}}) *{{$clientReqType}} {
	clientRequest := &{{$clientReqType}}{}

	{{ range $key, $value := .RequestFieldMap -}}
	{{ range $name, $type := $.Method.RequestTypeMap -}} {{if eq $name $key -}}
	clientRequest.{{title $key }} = {{ $type }}(body.{{title $value }})
	{{ end -}}
	{{ end -}}
	{{ end }}
	return clientRequest
}
{{end -}}


{{if and (ne .ResponseType "") (ne $clientResType "") -}}
func convert{{title .Name}}ClientResponse(body *{{$clientResType}}) *{{.ResponseType}} {
	// TODO: Add response fields mapping here.
	downstreamResponse := (*{{.ResponseType}})(body)
	return downstreamResponse
}
{{end -}}

{{end -}}
{{end -}}
